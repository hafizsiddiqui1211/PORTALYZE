"""PDF generation service for Resume Analyzer Core"""
from reportlab.lib.pagesizes import letter, A4
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, PageBreak
from reportlab.platypus import Table, TableStyle
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import inch
from reportlab.lib import colors
from reportlab.platypus.flowables import Image
from typing import Dict, List, Optional
import io
import os
from datetime import datetime
import time
from src.models.analysis import AnalysisResult
from src.models.suggestions import KeywordSuggestion
from src.utils.logger import get_logger


class PDFGenerator:
    """Generates professional PDF reports from analysis results"""

    def __init__(self):
        self.styles = getSampleStyleSheet()
        self.custom_styles = self._create_custom_styles()
        self.max_items_per_section = 10  # Limit items per section for performance
        self.logger = get_logger("PDFGenerator")

    def _create_custom_styles(self) -> Dict[str, ParagraphStyle]:
        """Create custom paragraph styles for the PDF."""
        styles = {}

        # Title style
        styles['Title'] = ParagraphStyle(
            'Title',
            parent=self.styles['Title'],
            fontSize=24,
            spaceAfter=30,
            alignment=1,  # Center alignment
            textColor=colors.HexColor('#2C3E50')
        )

        # Header style
        styles['Header'] = ParagraphStyle(
            'Header',
            parent=self.styles['Heading1'],
            fontSize=18,
            spaceAfter=12,
            textColor=colors.HexColor('#34495E'),
            borderWidth=1,
            borderColor=colors.HexColor('#BDC3C7'),
            borderPadding=6,
            backColor=colors.HexColor('#ECF0F1')
        )

        # Subheader style
        styles['Subheader'] = ParagraphStyle(
            'Subheader',
            parent=self.styles['Heading2'],
            fontSize=14,
            spaceAfter=8,
            textColor=colors.HexColor('#2980B9')
        )

        # Strength style
        styles['Strength'] = ParagraphStyle(
            'Strength',
            parent=self.styles['Normal'],
            fontSize=11,
            leftIndent=20,
            bulletText='✓',
            spaceAfter=6,
            textColor=colors.HexColor('#27AE60')
        )

        # Weakness style
        styles['Weakness'] = ParagraphStyle(
            'Weakness',
            parent=self.styles['Normal'],
            fontSize=11,
            leftIndent=20,
            bulletText='⚠',
            spaceAfter=6,
            textColor=colors.HexColor('#E74C3C')
        )

        # Normal content style
        styles['Content'] = ParagraphStyle(
            'Content',
            parent=self.styles['Normal'],
            fontSize=11,
            spaceAfter=6
        )

        return styles

    def generate_analysis_report(self, analysis_result: AnalysisResult,
                               keyword_suggestions: List[KeywordSuggestion],
                               role_recommendations: List = None,
                               filename: str = None) -> str:
        """
        Generate a comprehensive PDF analysis report.

        Args:
            analysis_result: The analysis result to include in the report
            keyword_suggestions: List of keyword suggestions to include
            role_recommendations: List of role recommendations to include
            filename: Optional filename for the PDF (if None, uses timestamp)

        Returns:
            Path to the generated PDF file
        """
        start_time = time.time()
        self.logger.info(f"Starting generation of comprehensive PDF report for analysis_id: {analysis_result.analysis_id}")

        if not filename:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"resume_analysis_report_{timestamp}.pdf"

        self.logger.debug(f"Creating PDF document at: {filename}")

        # Create the PDF document
        doc = SimpleDocTemplate(
            filename,
            pagesize=A4,
            rightMargin=72,
            leftMargin=72,
            topMargin=72,
            bottomMargin=18
        )

        # Create the story (content) for the PDF
        story = []

        # Add title
        title = Paragraph("Resume Analysis Report", self.custom_styles['Title'])
        story.append(title)
        story.append(Spacer(1, 20))

        # Add ATS Score section
        story.extend(self._create_ats_score_section(analysis_result))
        story.append(PageBreak())

        # Add strengths and weaknesses
        story.extend(self._create_strengths_weaknesses_section(analysis_result))
        story.append(PageBreak())

        # Add section feedback
        story.extend(self._create_section_feedback_section(analysis_result))
        story.append(PageBreak())

        # Add keyword suggestions
        story.extend(self._create_keyword_suggestions_section(keyword_suggestions))

        # Add overall feedback
        story.extend(self._create_overall_feedback_section(analysis_result))

        # Add role recommendations if provided
        if role_recommendations:
            story.append(PageBreak())
            story.extend(self._create_role_recommendations_section(role_recommendations))

        # Build the PDF
        doc.build(story)

        # Performance logging
        elapsed_time = time.time() - start_time
        if elapsed_time > 5:
            self.logger.warning(f"PDF generation took {elapsed_time:.2f}s, exceeding target of 5s for analysis_id: {analysis_result.analysis_id}")
        else:
            self.logger.info(f"PDF generated successfully in {elapsed_time:.2f}s for analysis_id: {analysis_result.analysis_id}")

        return filename

    def _create_ats_score_section(self, analysis_result: AnalysisResult) -> List:
        """Create the ATS score section of the report."""
        elements = []

        header = Paragraph("ATS Compatibility Score", self.custom_styles['Header'])
        elements.append(header)

        # Create a table for the score
        score_data = [
            ['ATS Score', f"{analysis_result.ats_score:.1f}/100"],
            ['Analysis Confidence', f"{analysis_result.confidence_level:.2f}"],
            ['Analysis Date', datetime.now().strftime("%Y-%m-%d %H:%M:%S")]
        ]

        score_table = Table(score_data, colWidths=[3*inch, 2*inch])
        score_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#34495E')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 14),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#BDC3C7'))
        ]))

        elements.append(score_table)
        elements.append(Spacer(1, 12))

        # Add score interpretation
        score_interpretation = self._get_score_interpretation(analysis_result.ats_score)
        interpretation_para = Paragraph(
            f"<b>Interpretation:</b> {score_interpretation}",
            self.custom_styles['Content']
        )
        elements.append(interpretation_para)
        elements.append(Spacer(1, 20))

        return elements

    def _get_score_interpretation(self, score: float) -> str:
        """Get interpretation text for an ATS score."""
        if score >= 80:
            return "Excellent ATS compatibility. Your resume is well-optimized for ATS systems and has a high chance of being selected."
        elif score >= 60:
            return "Good ATS compatibility. Your resume has a reasonable chance of being selected by ATS systems."
        elif score >= 40:
            return "Fair ATS compatibility. Consider adding more relevant keywords and improving formatting for better ATS visibility."
        else:
            return "Poor ATS compatibility. Significant improvements are needed to increase the chances of ATS selection."

    def _create_strengths_weaknesses_section(self, analysis_result: AnalysisResult) -> List:
        """Create the strengths and weaknesses section of the report."""
        elements = []

        header = Paragraph("Strengths and Areas for Improvement", self.custom_styles['Header'])
        elements.append(header)

        # Strengths
        strengths_header = Paragraph("Strengths", self.custom_styles['Subheader'])
        elements.append(strengths_header)

        for strength in analysis_result.strengths:
            strength_para = Paragraph(strength, self.custom_styles['Strength'])
            elements.append(strength_para)

        elements.append(Spacer(1, 12))

        # Weaknesses
        weaknesses_header = Paragraph("Areas for Improvement", self.custom_styles['Subheader'])
        elements.append(weaknesses_header)

        for weakness in analysis_result.weaknesses:
            weakness_para = Paragraph(weakness, self.custom_styles['Weakness'])
            elements.append(weakness_para)

        elements.append(Spacer(1, 20))

        return elements

    def _create_section_feedback_section(self, analysis_result: AnalysisResult) -> List:
        """Create the section feedback section of the report."""
        elements = []

        header = Paragraph("Section-by-Section Feedback", self.custom_styles['Header'])
        elements.append(header)

        for section_name, feedback in analysis_result.section_feedback.items():
            section_header = Paragraph(section_name.title(), self.custom_styles['Subheader'])
            elements.append(section_header)

            feedback_para = Paragraph(feedback, self.custom_styles['Content'])
            elements.append(feedback_para)
            elements.append(Spacer(1, 8))

        elements.append(Spacer(1, 20))

        return elements

    def _create_keyword_suggestions_section(self, keyword_suggestions: List[KeywordSuggestion]) -> List:
        """Create the keyword suggestions section of the report."""
        elements = []

        header = Paragraph("Keyword Suggestions for Improvement", self.custom_styles['Header'])
        elements.append(header)

        if not keyword_suggestions:
            no_suggestions = Paragraph("No keyword suggestions available.", self.custom_styles['Content'])
            elements.append(no_suggestions)
        else:
            # Create a table for keyword suggestions
            table_data = [['Keyword', 'Relevance', 'Category', 'Justification']]

            for suggestion in keyword_suggestions:
                table_data.append([
                    suggestion.keyword,
                    f"{suggestion.relevance_score:.2f}",
                    suggestion.category,
                    suggestion.justification[:50] + "..." if len(suggestion.justification) > 50 else suggestion.justification
                ])

            # Create table with style
            keyword_table = Table(table_data, colWidths=[1.5*inch, 1*inch, 1.2*inch, 2.3*inch])
            keyword_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#34495E')),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 10),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
                ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#BDC3C7')),
                ('FONTSIZE', (0, 1), (-1, -1), 9),
                ('VALIGN', (0, 0), (-1, -1), 'TOP')
            ]))

            elements.append(keyword_table)

        elements.append(Spacer(1, 20))

        return elements

    def _create_overall_feedback_section(self, analysis_result: AnalysisResult) -> List:
        """Create the overall feedback section of the report."""
        elements = []

        header = Paragraph("Overall Feedback", self.custom_styles['Header'])
        elements.append(header)

        feedback_para = Paragraph(analysis_result.overall_feedback, self.custom_styles['Content'])
        elements.append(feedback_para)

        elements.append(Spacer(1, 20))

        # Add recommendations
        recommendations_header = Paragraph("Recommendations", self.custom_styles['Subheader'])
        elements.append(recommendations_header)

        recommendations = [
            "Consider incorporating the suggested keywords into your resume",
            "Focus on improving the areas identified as weaknesses",
            "Ensure consistent formatting throughout your resume",
            "Quantify your achievements where possible"
        ]

        for rec in recommendations:
            rec_para = Paragraph(f"• {rec}", self.custom_styles['Content'])
            elements.append(rec_para)

        elements.append(Spacer(1, 20))

        return elements

    def generate_summary_report(self, analysis_result: AnalysisResult,
                              keyword_suggestions: List[KeywordSuggestion],
                              role_recommendations: List = None,
                              filename: str = None) -> str:
        """
        Generate a concise summary PDF report.

        Args:
            analysis_result: The analysis result to include in the report
            keyword_suggestions: List of keyword suggestions to include
            role_recommendations: List of role recommendations to include
            filename: Optional filename for the PDF (if None, uses timestamp)

        Returns:
            Path to the generated PDF file
        """
        start_time = time.time()

        if not filename:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"resume_summary_report_{timestamp}.pdf"

        # Create the PDF document
        doc = SimpleDocTemplate(
            filename,
            pagesize=letter,
            rightMargin=72,
            leftMargin=72,
            topMargin=72,
            bottomMargin=18
        )

        # Create the story (content) for the PDF
        story = []

        # Add title
        title = Paragraph("Resume Analysis Summary", self.custom_styles['Title'])
        story.append(title)
        story.append(Spacer(1, 20))

        # Add key metrics
        story.extend(self._create_key_metrics_section(analysis_result, keyword_suggestions))
        story.append(Spacer(1, 12))

        # Add top strengths
        story.extend(self._create_top_strengths_section(analysis_result))
        story.append(Spacer(1, 12))

        # Add top weaknesses
        story.extend(self._create_top_weaknesses_section(analysis_result))
        story.append(Spacer(1, 12))

        # Add top keyword suggestions
        story.extend(self._create_top_keyword_suggestions_section(keyword_suggestions))

        # Add role recommendations if provided
        if role_recommendations:
            story.append(Spacer(1, 12))
            story.extend(self._create_top_role_recommendations_section(role_recommendations))

        # Build the PDF
        doc.build(story)

        # Performance logging
        elapsed_time = time.time() - start_time
        if elapsed_time > 5:
            print(f"Warning: Summary PDF generation took {elapsed_time:.2f}s, exceeding target of 5s")
        else:
            print(f"Summary PDF generated successfully in {elapsed_time:.2f}s")

        return filename

    def _create_key_metrics_section(self, analysis_result: AnalysisResult, keyword_suggestions: List[KeywordSuggestion]) -> List:
        """Create the key metrics section for summary report."""
        elements = []

        header = Paragraph("Key Metrics", self.custom_styles['Header'])
        elements.append(header)

        # Create a table for key metrics
        metrics_data = [
            ['ATS Score', f"{analysis_result.ats_score:.1f}/100"],
            ['Confidence Level', f"{analysis_result.confidence_level:.2f}"],
            ['# Strengths Identified', str(len(analysis_result.strengths))],
            ['# Areas for Improvement', str(len(analysis_result.weaknesses))],
            ['# Keyword Suggestions', str(len(keyword_suggestions or []))]
        ]

        metrics_table = Table(metrics_data, colWidths=[3*inch, 2*inch])
        metrics_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#34495E')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#BDC3C7'))
        ]))

        elements.append(metrics_table)
        elements.append(Spacer(1, 20))

        return elements

    def _create_top_strengths_section(self, analysis_result: AnalysisResult) -> List:
        """Create the top strengths section for summary report."""
        elements = []

        header = Paragraph("Top Strengths", self.custom_styles['Header'])
        elements.append(header)

        for i, strength in enumerate(analysis_result.strengths[:3]):  # Top 3 strengths
            strength_para = Paragraph(f"{i+1}. {strength}", self.custom_styles['Content'])
            elements.append(strength_para)

        elements.append(Spacer(1, 20))

        return elements

    def _create_top_weaknesses_section(self, analysis_result: AnalysisResult) -> List:
        """Create the top weaknesses section for summary report."""
        elements = []

        header = Paragraph("Key Areas for Improvement", self.custom_styles['Header'])
        elements.append(header)

        for i, weakness in enumerate(analysis_result.weaknesses[:3]):  # Top 3 weaknesses
            weakness_para = Paragraph(f"{i+1}. {weakness}", self.custom_styles['Content'])
            elements.append(weakness_para)

        elements.append(Spacer(1, 20))

        return elements

    def _create_top_keyword_suggestions_section(self, keyword_suggestions: List[KeywordSuggestion]) -> List:
        """Create the top keyword suggestions section for summary report."""
        elements = []

        header = Paragraph("Top Keyword Suggestions", self.custom_styles['Header'])
        elements.append(header)

        if not keyword_suggestions:
            no_suggestions = Paragraph("No keyword suggestions available.", self.custom_styles['Content'])
            elements.append(no_suggestions)
        else:
            # Sort suggestions by relevance score
            sorted_suggestions = sorted(keyword_suggestions, key=lambda x: x.relevance_score, reverse=True)

            for i, suggestion in enumerate(sorted_suggestions[:5]):  # Top 5 suggestions
                suggestion_text = f"{i+1}. {suggestion.keyword} (Relevance: {suggestion.relevance_score:.2f}) - {suggestion.justification}"
                suggestion_para = Paragraph(suggestion_text, self.custom_styles['Content'])
                elements.append(suggestion_para)

        elements.append(Spacer(1, 20))

        return elements

    def _create_role_recommendations_section(self, role_recommendations: List) -> List:
        """Create the role recommendations section for the report."""
        elements = []

        header = Paragraph("Role Recommendations", self.custom_styles['Header'])
        elements.append(header)

        if not role_recommendations:
            no_roles = Paragraph("No role recommendations available.", self.custom_styles['Content'])
            elements.append(no_roles)
        else:
            # Create a table for role recommendations
            table_data = [['Role Title', 'Industry', 'Seniority Level', 'Fit Score', 'Key Justifications']]

            for role in role_recommendations[:10]:  # Limit to top 10 roles
                # Get the role attributes safely
                title = getattr(role, 'title', 'N/A')
                industry = getattr(role, 'industry', 'N/A')
                seniority = getattr(role, 'seniority_level', 'N/A')
                fit_score = getattr(role, 'fit_score', 0.0)

                # Format the fit score as percentage
                fit_score_str = f"{fit_score:.1%}"

                # Get justifications if available
                justification = getattr(role, 'justification', {})
                if isinstance(justification, dict):
                    # Extract key justifications
                    key_points = []
                    for key, value in list(justification.items())[:2]:  # Take first 2 justifications
                        key_points.append(str(value)[:60] + "..." if len(str(value)) > 60 else str(value))
                    justifications_str = "; ".join(key_points)
                else:
                    justifications_str = "See detailed analysis"

                table_data.append([
                    title,
                    industry,
                    seniority,
                    fit_score_str,
                    justifications_str
                ])

            # Create table with style
            role_table = Table(table_data, colWidths=[1.5*inch, 1.2*inch, 1.2*inch, 0.8*inch, 1.3*inch])
            role_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#34495E')),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 9),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
                ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#BDC3C7')),
                ('FONTSIZE', (0, 1), (-1, -1), 8),
                ('VALIGN', (0, 0), (-1, -1), 'TOP')
            ]))

            elements.append(role_table)

            # Add summary statistics
            elements.append(Spacer(1, 12))
            avg_fit_score = sum(getattr(r, 'fit_score', 0.0) for r in role_recommendations) / len(role_recommendations) if role_recommendations else 0
            stats_text = f"Total Roles: {len(role_recommendations)}, Average Fit Score: {avg_fit_score:.1%}"
            stats_para = Paragraph(stats_text, self.custom_styles['Content'])
            elements.append(stats_para)

        elements.append(Spacer(1, 20))

        return elements

    def _create_top_role_recommendations_section(self, role_recommendations: List) -> List:
        """Create the top role recommendations section for summary report."""
        elements = []

        header = Paragraph("Top Role Recommendations", self.custom_styles['Header'])
        elements.append(header)

        if not role_recommendations:
            no_roles = Paragraph("No role recommendations available.", self.custom_styles['Content'])
            elements.append(no_roles)
        else:
            # Sort roles by fit score (descending)
            sorted_roles = sorted(role_recommendations, key=lambda r: getattr(r, 'fit_score', 0.0), reverse=True)

            for i, role in enumerate(sorted_roles[:5]):  # Top 5 roles
                title = getattr(role, 'title', 'N/A')
                industry = getattr(role, 'industry', 'N/A')
                seniority = getattr(role, 'seniority_level', 'N/A')
                fit_score = getattr(role, 'fit_score', 0.0)

                role_text = f"{i+1}. {title} ({industry}) - {seniority} Level - Fit Score: {fit_score:.1%}"
                role_para = Paragraph(role_text, self.custom_styles['Content'])
                elements.append(role_para)

                # Add brief justification if available
                justification = getattr(role, 'justification', {})
                if isinstance(justification, dict):
                    # Extract a brief justification
                    if 'skill_alignment' in justification:
                        brief_just = str(justification['skill_alignment'])[:100] + "..." if len(str(justification['skill_alignment'])) > 100 else str(justification['skill_alignment'])
                        just_para = Paragraph(f"   Justification: {brief_just}", self.custom_styles['Content'])
                        elements.append(just_para)

        elements.append(Spacer(1, 20))

        return elements

    def generate_pdf_from_template(self, data: Dict, template_path: str, output_path: str) -> str:
        """
        Generate a PDF using a custom template.

        Args:
            data: Data to populate in the template
            template_path: Path to the template file
            output_path: Output path for the generated PDF

        Returns:
            Path to the generated PDF file
        """
        # This is a placeholder for more advanced template-based PDF generation
        # For now, we'll just generate a standard report
        raise NotImplementedError("Template-based PDF generation not yet implemented")